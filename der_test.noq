rule square_def square(x) = x^2
rule parens (a) - b = a - b
rule swap a + b - c = a - c + b
rule swap_sum a + b = b + a
rule sub a - a = 0
rule sum_id 0 + a = a
rule lim_replace lim(var, value, expr) = replace(var, value, expr)
rule div_distrib (a + b) / c = a / c + b / c

rule square_of_sum (x + y)^2 = 2*x*y + y^2
rule der_def der(x) = lim(dx, 0, (f(x + dx) - f(x)) / dx)

shape der(square)
    apply der_def
    apply square_def
    apply square_of_sum
    apply parens
    apply swap
    apply swap
    apply sub
    apply sum_id
    apply div_distrib
    apply rule (a^2) / a = a
    apply rule (a*b*c) / c = a*b
    apply lim_replace
    apply swap_sum
    apply sum_id
done
